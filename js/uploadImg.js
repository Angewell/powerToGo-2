$(function(){$.post("http://wxtoken.k-run.cn/generate",{url:location.href.split("#")[0]},function(q){q=JSON.parse(q);console.log(q);wx.config({debug:false,appId:"wx4c166202e798d4cc",timestamp:q.timestamp,nonceStr:q.noncestr,signature:q.signature,jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage"]})});wx.ready(function(){o({shareTitle:"刚跟偶像拍了张海报，心都开花了!",shareDesc:"2016行走的力量，让心开出花来",shareImg:"http://powertogo6.k-run.cn/logo.jpg",shareLink:"http://powertogo6.k-run.cn/"})});var p=new Swiper(".swiper-container",{direction:"vertical",pagination:".swiper-pagination"});var e=$("body").width(),f=$(window).height(),i=navigator.userAgent.match(/iphone/i);if(e*1.35>f-60){$("#p3_btn_wrap").css({height:"60px"});$("#p3_btn").css({height:"40px","line-height":"40px"})}else{$("#p3_btn_wrap").css({height:f-(e*1.35)+"px"})}var g=$("#page_2_name");var j=$("#clipArea");j.height($(window).height()-170);j.photoClip({width:e*0.75,height:e*0.75*1.35,file:"#file",view:"#hit",ok:"#clipBtn",strictSize:true,clipFinish:function(q){$("#hit").attr("src",q);if($.trim(g.val())==""){alert("请输入你的名字！");return}if($.trim(g.val()).length>5){alert("请把名字字数控制在5字以内！");return}b(q);$(".page.on").removeClass("on");$("#page_3").addClass("on");o({shareTitle:"刚跟偶像拍了张海报，心都开花了!",shareDesc:"2016行走的力量，让心开出花来",shareImg:"http://powertogo6.k-run.cn/logo.jpg",shareLink:"http://powertogo6.k-run.cn/"})}});var d=$(".flower"),c=$(".logo"),l=$(".text"),m=(e*0.75)/500;d.css({"-webkit-transform":"scale("+m+")","transform":"scale("+m+")","top":300*m+"px","width":200*m+"px","height":370*m+"px"});c.css({"-webkit-transform":"scale("+m+")","transform":"scale("+m+")","width":171*m+"px","height":156*m+"px","right":70*m+"px","top":304*m+"px"});l.css({"height":145*m+"px","bottom":30*m+"px"});$(".f_9").click(function(q){$(".page.on").removeClass("on");$("#page_2").addClass("on")});var a=$("#page_1"),n=1,h;a.find(".f_1").addClass("on");$(window).load(function(){h=setInterval(function(){if(n<9){n++;a.find(".on").removeClass("on");a.find(".f_"+n).addClass("on")}else{clearInterval(h);var q=$(".photo-clip-view");d.appendTo(q);l.appendTo(q);c.appendTo(q)}},2000)});$("#upload2").on("click",function(){$("#file").click()});$("#mask").click(function(){$(this).stop().fadeOut(200)});$("#p3_btn").click(function(){$("#kun_say").stop().fadeIn(200)});$("#say_btn").click(function(q){q.stopPropagation();$("#container").removeClass("on");$("#swiperBox").addClass("on")});$("#kun_say").click(function(){$(this).stop().fadeOut(200)});function o(q){wx.onMenuShareTimeline({title:q.shareTitle,link:q.shareLink,imgUrl:q.shareImg});wx.onMenuShareAppMessage({title:q.shareTitle,desc:q.shareDesc,link:q.shareLink,imgUrl:q.shareImg})}function b(s){if(s==""){alert("图像上传失败，请重试")}var r=256;var q=new Image();q.onload=function(){k($.trim(g.val()),q)};q.src=s}function k(q,r){$.post("http://powertogo6.k-run.cn/submit.do",{name:q},function(J){console.log(J);if(J.status==1000){$(".xingzhe_num").text(J.result.numStr);$("#slide_name").text(J.result.name);var u=document.getElementById("myCanvas"),t=document.getElementById("p3_flower"),w=document.getElementById("p3_logo"),I=document.getElementById("p3_text"),v=256;if(r.height>v){r.width*=v/r.height;r.height=v}var A=u.getContext("2d");A.clearRect(0,0,u.width,u.height);A.drawImage(r,0,0,500,675);A.drawImage(t,300,280,200,370);A.drawImage(w,304,260,171,156);A.drawImage(I,0,507,500,144);var G=J.result.name,z="，第"+J.result.numStr+"位行者",F=460,E=20;for(var B=0,H=G.length;B<H;B++){A.font="19px '黑体'";A.fillStyle="#231815";A.strokeStyle="#231815";A.textBaseline="top";A.fillText(G[B],F,E);A.strokeText(G[B],F,E);E+=20}for(var C=0,D=z.length;C<D;C++){var y=z[C];if(y=="，"){A.drawImage($("#p3_word_dou").get(0),F,E,18,13);E+=14}else{if(y=="第"){A.drawImage($("#p3_word_di").get(0),F,E,18,17);E+=18}else{if(y=="位"){A.drawImage($("#p3_word_wei").get(0),F,E,18,17);E+=18}else{if(y=="行"){A.drawImage($("#p3_word_xing").get(0),F,E,18,17);E+=18}else{if(y=="者"){A.drawImage($("#p3_word_zhe").get(0),F,E,18,17);E+=18}else{if(typeof(parseInt(y))=="number"){A.drawImage($("#p3_word_"+parseInt(y)).get(0),F,E,18,13);E+=14}}}}}}}var s=u.toDataURL("image/png"),x=encodeURIComponent(s);$("#p3_card").attr("src",s);$.post("http://powertogo6.k-run.cn/upload.do",{imgContent:s.split(",")[1]},function(K){console.log(K);if(K.status==1000){$("#p3_card").attr("src",K.thumb);$("#mask").delay(1800).fadeOut(200)}else{alert("图片生成失败，请重试")}})}})}});